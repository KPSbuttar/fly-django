<script>
function loginFacebook() {
    FB.login(function(){
        // Note: The call will only work if you accept the permission request
        FB.getLoginStatus(function(response){
            if(response.status === 'connected'){
                console.log("1 of 2");
                console.log(JSON.stringify(response.authResponse.accessToken));
                saveKeyToStorage('facebook',response.authResponse.accessToken);
                      
                // Interface with our app.
                flyapp_register_token(
                    response.authResponse.accessToken,
                    function(json_result) {
                        console.log("Success");
                        console.log(json_result);
                    },
                    function(error_json) {
                        console.log("Error");
                        console.log(error_json);
                    }
                );
            }
        })
        FB.api(
            '/me',
            'GET',
            {"fields":"name,first_name,last_name,email"},
            function(response) {
                console.log(JSON.stringify(response));
                saveUserToStorage(
                    response['id'],
                    response['name'],
                    response['first_name'],
                    response['last_name'],
                    response['email'],
                    'http://graph.facebook.com/' + response['id'] + '/picture?type=normal'
                );
                console.log("2 of 2");
                //window.location="/dashboard";
            }
        );
    }, {scope: 'email,publish_actions'});
}

//curl -X POST -d "grant_type=convert_token&client_id=<client_id>&client_secret=<client_secret>&backend=facebook&token=<facebook_token>" http://localhost:8000/auth/convert-token


function flyapp_register_token(token, success_callback, error_callback) {
    var data = {
        'grant_type': 'convert_token',
        'client_id': '{{ settings.SOCIAL_AUTH_FACEBOOK_KEY }}',
        'client_secret': '{{ settings.SOCIAL_AUTH_FACEBOOK_SECRET }}',
        'backend': 'facebook',
        'token': token,
    };
    var url = "/auth/convert-token";
    
    jQuery.ajax({
        url: url,
        data: data,
        type: "POST",
        traditional: true, // Note: This allows many-to-many arrays for Django REST Framework
        success: function(json_result){
            success_callback(json_result); // Call back the function with the JSON results.
        },
        error: function(xhr,status,error) {
            // Print the error log to console.
            console.debug(status + ': ' + error + ' -- ' + xhr.responseText);
                
            // Convert JSON string into javascript associative array.
            var json = jQuery.parseJSON(xhr.responseText);
            error_callback(json); // Return JSON
        },
        complete: function(xhr,status) {
            // Do nothing.
        }
    });
}


/*
function flyapp_register(id, name, first_name, last_name, email, picture, success_callback, error_callback) {
    var data = {
        'username': username,
        'email': email,
        'password': password,
        'first_name': first_name,
        'last_name': last_name,
    };
    var url = "/api/registers/0/registration/?format=json";
    
    jQuery.ajax({
                url: url,
                data: data,
                type: "POST",
                traditional: true, // Note: This allows many-to-many arrays for Django REST Framework
                success: function(json_result){
                success_callback(json_result); // Call back the function with the JSON results.
                },
                error: function(xhr,status,error) {
                // Print the error log to console.
                console.debug(status + ': ' + error + ' -- ' + xhr.responseText);
                
                // Convert JSON string into javascript associative array.
                var json = jQuery.parseJSON(xhr.responseText);
                error_callback(json); // Return JSON
                },
                complete: function(xhr,status) {
                // Do nothing.
                }
                });
    
}
*/
</script>